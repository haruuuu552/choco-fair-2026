<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choco Fair 2026 - Valentine Special</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Gaegu:wght@700&family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --milk-pink: #ffdae3;
            --magazine-red: #e9546b;
            --sanrio-brown: #5c4033;
            --cream-white: #fffef8; 
            --love-pink: #ff85a2;
            --choco-color: #4d332d;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Noto Sans SC', sans-serif; }
        
        .world { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            background: url('bg.jpg') no-repeat center center/cover;
            background-color: var(--milk-pink); 
        }
        
        #page1 { 
            position: absolute; inset: 0; z-index: 1000; 
            background-image: radial-gradient(rgba(255,255,255,0.4) 20%, transparent 20%); 
            background-size: 30px 30px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; 
        }
        
        .magazine-title { font-family: 'Gaegu', cursive; font-size: 7rem; color: var(--magazine-red); text-shadow: 4px 4px 0 #fff; text-align: center; line-height: 0.9; margin: 0; }

        @keyframes characterFloat { 0%, 100% { margin-bottom: 0px; } 50% { margin-bottom: 15px; } }
        .portrait-container { position: fixed; bottom: 60px; left: 10%; height: 90vh; width: 60%; display: none; align-items: flex-end; pointer-events: none; z-index: 10; }
        #char-portrait { height: 100%; width: auto; transition: transform 0.3s ease-out, opacity 0.3s ease; animation: characterFloat 3s ease-in-out infinite; }

        .page { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: flex-end; }
        .dialogue-area { width: 92%; max-width: 1000px; margin-bottom: 30px; z-index: 100; pointer-events: auto; }
        .name-tag { background: var(--love-pink); color: white; display: inline-block; padding: 10px 50px; border-radius: 20px 20px 0 0; border: 4px solid var(--sanrio-brown); font-weight: bold; font-size: 1.2rem; }
        .text-window { background: rgba(255,255,255,0.92); padding: 40px 60px; border-radius: 0 30px 30px 30px; border: 4px solid var(--sanrio-brown); min-height: 140px; cursor: pointer; }

        @keyframes popInFeedback {
            0% { transform: scale(0) translateY(0); opacity: 0; }
            20% { transform: scale(1) translateY(-20px); opacity: 1; }
            80% { transform: scale(1) translateY(-40px); opacity: 1; }
            100% { transform: scale(0.9) translateY(-60px); opacity: 0; }
        }

        #mood-container { position: absolute; inset: 0; pointer-events: none; z-index: 9999; }
        .mood-feedback-wrap { position: fixed; display: flex; flex-direction: column; align-items: center; animation: popInFeedback 1.8s ease-out forwards; }
        .mood-circle { width: 70px; height: 70px; border-radius: 50% !important; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); object-fit: cover; object-position: top; background: white; }
        .mood-bubble { background: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; margin-bottom: 6px; border: 2px solid var(--love-pink); color: var(--sanrio-brown); font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.1); white-space: nowrap; }

        #choco-craft-layer { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); background: rgba(255, 240, 243, 0.4); }
        .studio-layout { display: grid; grid-template-columns: 540px 220px 260px; gap: 15px; padding: 25px; border-radius: 40px; background: rgba(255, 255, 255, 0.85); border: 2px solid #fff; align-items: start; position: relative; }

        .panel-block { background: var(--cream-white); border-radius: 25px; padding: 15px; border: 2px solid rgba(92, 64, 51, 0.1); }
        .choco-box { width: 540px; height: 480px; background: var(--cream-white); border-radius: 30px; position: relative; overflow: hidden;} 
        .heart-shape { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 400px; height: 360px; background: var(--choco-color); clip-path: path('M200 360 L35 180 A95 95 0 0 1 200 90 A95 95 0 0 1 365 180 Z'); }
        #canvas { position: absolute; inset: 0; z-index: 5; cursor: crosshair; }

        .color-title { font-size: 0.75rem; font-weight: bold; color: var(--sanrio-brown); margin-bottom: 8px; border-left: 3px solid var(--love-pink); padding-left: 5px; }
        .dot { width: 34px; height: 34px; border-radius: 50%; border: 2px solid #eee; cursor: pointer; transition: transform 0.2s; }
        .dot.active { border-color: var(--love-pink); transform: scale(1.1); box-shadow: 0 0 8px rgba(255,133,162,0.4); }
        .action-btn { padding: 8px; border-radius: 50px; border: 2px solid var(--sanrio-brown); font-family: 'ZCOOL KuaiLe'; cursor: pointer; background: white; font-weight: bold; font-size: 0.85rem; margin-bottom: 5px; transition: all 0.2s ease; }
        .action-btn:hover { transform: translateY(-2px); background: #fffafb; }
        .brush-toggle { border: 2px solid var(--sanrio-brown); border-radius: 10px; display: flex; overflow: hidden; margin-bottom: 10px; }
        .brush-toggle button { flex: 1; border: none; padding: 8px; cursor: pointer; background: white; font-size: 0.8rem; font-weight: bold; }
        .brush-toggle button.active { background: var(--sanrio-brown); color: white; }

        .sticker-wrapper { position: absolute; cursor: move; z-index: 20; padding: 10px; border: 2px dashed transparent; display: flex; align-items: center; justify-content: center; }
        .sticker-wrapper.active { border-color: var(--love-pink); background: rgba(255, 133, 162, 0.05); }
        .sticker-content { font-size: 60px; user-select: none; pointer-events: none; display: block; line-height: 1; }
        .sticker-content img { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .handle { position: absolute; width: 16px; height: 16px; border-radius: 50%; display: none; z-index: 30; }
        .sticker-wrapper.active .handle { display: block; }
        .handle-se { right: -8px; bottom: -8px; cursor: nwse-resize; background: #2E5BFF; border: 2px solid white; }
        .handle-del { left: -8px; top: -8px; cursor: pointer; background: var(--magazine-red); border: 2px solid white; color: white; font-size: 12px; font-family: Arial; text-align: center; line-height: 14px; font-weight: bold; }
        .sticker-vault { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 120px; overflow-y: auto; margin-top: 5px; }
        .mini-sticker-btn { width: 100%; aspect-ratio: 1; border-radius: 50%; border: 2px solid #eee; cursor: pointer; object-fit: cover; }

        #unboxing-layer { 
            position: fixed; inset: 0; z-index: 3000; display: none; 
            background: linear-gradient(rgba(255, 240, 243, 0.6), rgba(255, 240, 243, 0.6)), url('bg.jpg') no-repeat center center/cover;
            flex-direction: column; align-items: center; justify-content: center;
        }
        
        .plate-container { 
            position: relative; 
            width: 620px; height: 520px; 
            background: #fff; border-radius: 50%; 
            box-shadow: 0 15px 40px rgba(255,133,162,0.3);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 30px;
            border: 6px dashed var(--love-pink);
            outline: 15px solid #fff;
            animation: platePop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes platePop { from { transform: scale(0.8) translateY(50px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        #final-choco-view { position: relative; width: 540px; height: 480px; z-index: 2; pointer-events: none; transform: scale(0.95); }

        @keyframes sparkleAnim {
            0%, 100% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
        }
        .sparkle-deco { position: absolute; color: var(--love-pink); font-size: 24px; animation: sparkleAnim 2s infinite ease-in-out; pointer-events: none; z-index: 1; }

        .gift-box-wrapper { cursor: pointer; text-align: center; transition: 0.3s; margin-top: 10px; z-index: 5;}
        .gift-box-wrapper:hover { transform: scale(1.1) rotate(-3deg); }
        .gift-label { margin-top: 15px; font-family: 'Gaegu'; font-size: 1.8rem; color: #fff; background: var(--love-pink); padding: 8px 35px; border-radius: 50px; box-shadow: 0 5px 15px rgba(255,133,162,0.4); }

        #call-layer { position: fixed; inset: 0; z-index: 4000; display: none; background: rgba(255,240,245,0.96); backdrop-filter: blur(10px); }
        .card-container { position: relative; width: 85vw; max-width: 420px; background: #fff; padding: 18px 18px 65px 18px; box-shadow: 0 25px 50px rgba(0,0,0,0.1); transform: rotate(-2deg); margin: 6vh auto; border-radius: 4px; }
        .card-photo-frame { width: 100%; aspect-ratio: 1/1; background-size: cover; background-position: center; border: 1px solid #f0f0f0; }
        .card-name-text { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 700; font-size: 3rem; color: var(--sanrio-brown); text-align: center; margin-top: 25px; letter-spacing: 2px; }
        .listen-btn-wrap { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .round-action-btn { width: 85px; height: 85px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 12px 25px rgba(233,84,107,0.3); transition: 0.3s; }
        .btn-play { background: var(--magazine-red); color: white; }
        .btn-close { background: #fff; color: var(--sanrio-brown); font-size: 1.5rem; }
        
        @keyframes floatHearts { 0% { transform: translateY(0) scale(1); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-120px) scale(1.3); opacity: 0; } }
        .heart-particle { position: absolute; pointer-events: none; animation: floatHearts 2s linear forwards; color: var(--love-pink); }
    </style>
</head>
<body>
<div class="world">
    <div id="page1" onclick="nextPage()">
        <h1 class="magazine-title">CHOCO<br>FAIR</h1>
        <div style="background:var(--sanrio-brown); color:white; margin-top:30px; padding:15px 50px; border-radius:50px; font-weight:bold;">ENTER ‚Üí</div>
    </div>
    
    <div class="portrait-container" id="p-container"><img id="char-portrait" src=""></div>
    
    <div class="page" id="page2">
        <div style="position: absolute; top: 50%; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; z-index: 200; pointer-events: none;">
            <button onclick="changeMember(-1)" style="background:white; border:3px solid var(--sanrio-brown); border-radius:50%; width:60px; height:60px; cursor:pointer; pointer-events: auto;">‚óÄ</button>
            <button onclick="changeMember(1)" style="background:white; border:3px solid var(--sanrio-brown); border-radius:50%; width:60px; height:60px; cursor:pointer; pointer-events: auto;">‚ñ∂</button>
        </div>
        <div class="dialogue-area">
            <div class="name-tag" id="char-name">NAME</div>
            <div class="text-window" onclick="startCrafting()">
                <p id="char-text" style="font-size: 1.5rem; color: var(--sanrio-brown); font-weight: bold; margin: 0;"></p>
                <div style="text-align:right; font-size:0.9rem; color:var(--love-pink); margin-top:15px;">[ üç´ ÁÇπÂáªÂºÄÂßãÂà∂‰Ωú ]</div>
            </div>
        </div>
    </div>

    <div id="choco-craft-layer">
        <div class="studio-layout">
            <div id="mood-container"></div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="choco-box panel-block" id="paint-area" style="padding:0;">
                    <div class="heart-shape"></div>
                    <canvas id="canvas"></canvas>
                </div>
                <div class="panel-block" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size:0.8rem; font-weight:bold; white-space:nowrap;">Á¨îËß¶Â§ßÂ∞è</span>
                    <input type="range" id="pen-size" min="4" max="60" value="12" style="flex:1;">
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="panel-block"><div class="color-title">È©¨Âç°ÈæôËâ≤ÂΩ©</div><div id="macaron-colors" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px;"></div></div>
                <div class="panel-block"><div class="color-title">ÊàêÂëòËâ≤ÂΩ©</div><div id="member-colors" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px;"></div></div>
                <button class="action-btn" style="background:var(--magazine-red); color:white; height:100px; border:none; margin-top:auto;" onclick="finishCrafting()">Âà∂‰ΩúÂÆåÊàê ‚ú®</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="panel-block">
                    <div class="color-title">Á¨îËß¶Ë¥®ÊÑü</div>
                    <div class="brush-toggle"><button id="mode-silky" class="active" onclick="setBrush('silky')">‰∏ùÊªë</button><button id="mode-creamy" onclick="setBrush('creamy')">Â•∂Ê≤π</button></div>
                    <button class="action-btn" style="width:100%" onclick="toggleEraser()">Ê©°ÁöÆÊì¶ üßΩ</button>
                </div>
                <div class="panel-block">
                    <div class="color-title">ÁÉòÁÑôË£ÖÈ•∞</div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-bottom:12px;">
                        <button class="action-btn" title="ËçâËéì" onclick="addSticker('üçì')">üçì</button>
                        <button class="action-btn" title="Êõ≤Â•á" onclick="addSticker('üç™')">üç™</button>
                        <button class="action-btn" title="Ëù¥Ëù∂Áªì" onclick="addSticker('üéÄ')">üéÄ</button>
                        <button class="action-btn" title="Áà±ÂøÉ" onclick="addSticker('üíù')">üíù</button>
                    </div>
                    <div class="color-title">ÊàêÂëòË¥¥Á∫∏Â∫ì</div>
                    <div class="sticker-vault" id="sticker-vault-grid"></div>
                </div>
                <div class="panel-block">
                    <button class="action-btn" style="width:100%" onclick="initCanvas()">Ê∏ÖÁ©∫ üóëÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <div id="unboxing-layer">
        <div class="plate-container">
            <div id="final-choco-view"></div>
        </div>
        <div class="gift-box-wrapper" onclick="showCallScreen()">
            <div style="width:100px; height:80px; background:white; border-radius:15px; position:relative; margin:0 auto; border:4px solid var(--love-pink); box-shadow: 0 10px 0 #ffdae3;">
                <div style="position:absolute; top:0; left:50%; width:12px; height:100%; background:var(--love-pink); transform:translateX(-50%);"></div>
                <div style="position:absolute; top:40%; left:0; width:100%; height:12px; background:var(--love-pink);"></div>
                <div style="position:absolute; top:-25px; left:50%; transform:translateX(-50%); font-size:50px;">üéÄ</div>
            </div>
            <div class="gift-label">Open Message</div>
        </div>
    </div>

    <div id="call-layer">
        <div class="card-container">
            <div class="card-photo-frame" id="call-bg-img"></div>
            <div class="card-name-text" id="caller-name">MEMBER</div>
            <div style="text-align: center; font-family: 'Gaegu'; color: #ccb; margin-top: 8px;">Happy Valentine's Day!</div>
            <div class="listen-btn-wrap">
                <button class="round-action-btn btn-close" onclick="location.reload()">‚úï</button>
                <button class="round-action-btn btn-play" id="play-trigger" onclick="acceptCall()">
                    <span id="play-icon" style="font-size: 2.2rem;">‚ô•</span>
                </button>
            </div>
        </div>
        <div id="heart-spawner" style="position:absolute; inset:0; pointer-events:none;"></div>
    </div>
</div>

<script>
    const members = [
        { name: "KAI", color: "#2E5BFF", img: "kai.png", circle: "kai1.png", audio: "kai_audio.mp3", scale: 1.15, x: 100, y: 180, text: "ÈÇ£‰∏™...‰∏ÄÁõ¥ÁõØÁùÄÊàëÁöÑËÑ∏ÁúãÁöÑËØùÔºåÂ∑ßÂÖãÂäõÂèØÊòØ‰ºöÁ≥äÊéâÁöÑÂì¶ÔºüËØ∑‰∏ìÂøÉ‰∏ÄÁÇπ„ÄÇ" },
        { name: "RYOGA", color: "#9D27FF", img: "ryoga.png", circle: "ryoga1.png", audio: "ryoga_audio.mp3", scale: 1.1, x: 100, y: 150, text: "ÂñÇÂñÇÔºåÁ®çÂæÆÊêÖÊãåÂæóËøáÂ§¥‰∫ÜÂêßÔºÅÁúüÊòØÂú∞...ÊûúÁÑ∂Ê≤°ÊàëÁúãÁùÄÊòØ‰∏çË°åÁöÑÂëê„ÄÇ" },
        { name: "TAKUYA", color: "#32CD32", img: "takuya.png", circle: "takuya1.png", audio: "takuya_audio.mp3", scale: 0.95, x: 50, y: 50, text: "ÂÜçËøôÊ†∑Áîª‰∏ãÂéªÔºåÂ∞±Ë¶ÅÂèòÊàêÂéâÂÆ≥ÁöÑ‚ÄúËâ∫ÊúØÂìÅ‚Äù‰∫ÜÂë¢„ÄÇÂòõÔºåÁ∫øÊù°ÂÜçÁªÜ‰∏ÄÁÇπ‰ºöÊõ¥Â•ΩÁúãÂñî„ÄÇ" },
        { name: "YUKI", color: "#FF1744", img: "yuki.png", circle: "yuki1.png", audio: "yuki_audio.mp3", scale: 0.8, x: 100, y: 30, text: "ÂëúÂì¶‚Äî‚ÄîÔºÅÁúüÁöÑÊàêÂûã‰∫ÜÔºÅÂëêÔºåÁúãÂêßÔºüÊàëÂ∞±ËØ¥Êàë‰ª¨ÁöÑÈªòÂ•ëÊòØË∂ÖÁæ§ÁöÑÔºÅ" },
        { name: "TAKASHI", color: "#FFFFFF", img: "takashi.png", circle: "takashi1.png", audio: "takashi1.mp3", scale: 1.05, x: 200, y: 80, text: "ËøôÁßçÁªÜËá¥ÁöÑÂ∑•‰ΩúÔºåÊÑèÂ§ñÂú∞ÂæàÈúÄË¶ÅËÄêÂøÉÂë¢„ÄÇÂ¶ÇÊûú‰∏ç‰ªãÊÑèÁöÑËØùÔºåÊàëÈô™‰Ω†ÊÖ¢ÊÖ¢ÂÆåÊàêÂêßÔºü" },
        { name: "SHUYA", color: "#4D261A", img: "shuya.png", circle: "shuya1.png", audio: "shuya_audio.mp3", scale: 1.4, x: 100, y: 250, text: "Ê≤°ÂÖ≥Á≥ªÁöÑÂìüÔºåÂ∞ΩÁÆ°Â§ßËÉÜÂú∞ÁîªÂêßÔºÅÂ¶ÇÊûúÁîªÊ≠™‰∫ÜÔºåÂ∞±ËØ¥ÊòØÊàëÁöÑË¥£‰ªªÂ•ΩÂï¶„ÄÇ" },
        { name: "MASAHIRO", color: "#B0BEC5", img: "masahiro.png", circle: "masahiro1.png", audio: "masahiro_audio.mp3", scale: 0.7, x: 50, y: 70, text: "ËøûËøôÁßçÂú∞ÊñπÈÉΩËøô‰πàËÆ§ÁúüÂë¢...Êàë‰πü‰∏çËÉΩËæìÔºå‰ºöÂä™ÂäõÊääÂåÖË£Ö‰πüÂÅöÂæóÂæàÂÆåÁæéÁöÑ„ÄÇ" },
        { name: "ALOHA", color: "#00CED1", img: "aloha.png", circle: "aloha1.png", audio: "aloha_audio.mp3", scale: 0.8, x: 100, y: 80, text: "ËôΩÁÑ∂ÂΩ¢Áä∂Á®çÂæÆÊúâ‰∏ÄÁÇπÁÇπÂæÆÂ¶ô...‰ΩÜÊó¢ÁÑ∂ÊòØÊàë‰ª¨‰∏ÄËµ∑ÂÅöÁöÑÔºåÈÇ£Â∞±ÊòØÂ§ßÊàêÂäüÔºÅ" },
        { name: "HARU", color: "#FF9100", img: "haru.png", circle: "haru1.png", audio: "haru_audio.mp3", scale: 1.0, x: 100, y: 10, text: "ÂòøÂòø‚Äî‚ÄîÂÖ∂ÂÆûÂàöÊâçÔºåÊàëÊÇÑÊÇÑÂæÄÈáåÈù¢Âä†‰∫Ü‰∏ÄÁÇπÁæéÂë≥ÁöÑ‚ÄúÈ≠îÊ≥ï‚ÄùÂì¶„ÄÇ" }
    ];

    // ‚ú® Ê†∏ÂøÉ‰ºòÂåñÔºöËµÑÊ∫êÈ¢ÑÂä†ËΩΩÂºïÊìé ‚ú®
    (function preloadAllAssets() {
        members.forEach(m => {
            // È¢ÑÂä†ËΩΩ‰∏ªÁ´ãÁªò
            const imgMain = new Image(); imgMain.src = m.img;
            // È¢ÑÂä†ËΩΩÂúÜÂΩ¢Â§¥ÂÉè
            const imgCircle = new Image(); imgCircle.src = m.circle;
            // È¢ÑÂä†ËΩΩÈÄöËØùÂç°Èù¢
            const imgCard = new Image(); imgCard.src = m.name.toLowerCase() + "3.jpg";
        });
    })();

    let curIdx = 0, writing = false, penColor = "#ffffff", isEraser = false, brushMode = 'silky', lx, ly;
    let globalAudio = new Audio(); 

    const portrait = document.getElementById('char-portrait'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), pContainer = document.getElementById('p-container'), paintArea = document.getElementById('paint-area'), moodContainer = document.getElementById('mood-container');

    const memberQuotesData = {
        'KAI': ['Âæà‰∏äÊâãÂòõ', 'Â•ΩÂøÉÂä® ‚ú®', 'ÊÉ≥Âø´ÁÇπÁúãÂà∞ÊàêÂìÅ...'],
        'RYOGA': ['ÂñÇÂñÇ', 'ÂæàÊúâ‰∏™ÊÄßÂòõ', 'Âà´ÂàÜÂøÉÂëÄ'],
        'TAKUYA': ['Á∫øÊù°ÂæàÊúâÁÅµÊÄß', 'Ëâ≤ÂΩ©ÈÄâÂæóÁúüÂ•Ω', 'ÂæàÊúâÂìÅÂë≥Âñî'],
        'YUKI': ['ÂñîÂñîÔºÅË∂ÖÊúâÊ∞îÂäøÔºÅ', '‰Ω†ÊòØÂ§©ÊâçÂêóÔºü', 'Â§ßÊàêÂäüÔºÅ'],
        'TAKASHI': ['ÊÖ¢ÊÖ¢Áîª', 'ÂøÉÊÑè‰º†ËææËøáÊù•‰∫Ü', 'ÊàëÈô™ÁùÄ‰Ω†'],
        'SHUYA': ['Â§ßËÉÜÁîªÔºÅ', 'Ë∂ÖÊ£í~', 'Âä†Ê≤πÂñî~'],
        'MASAHIRO': ['Â•ΩÁªÜËá¥Âïä...', 'ÊúâÁÇπÈ•ø‰∫Ü', 'Áúü‰∏çÈîô'], 
        'ALOHA': ['Wow!', 'Â§™ÈÖ∑‰∫ÜÔºÅü§ô', 'ÂæàÊúâ FeelÔºÅ'],
        'HARU': ['ÊàëÊúÄÂñúÊ¨¢Âï¶', 'ÂòøÂòø~', 'ÁúãËµ∑Êù•ÂæàÂ•ΩÂêÉÔºÅ']
    };

    const quotePools = {};
    function getNextQuote(memberName) {
        if (!quotePools[memberName] || quotePools[memberName].length === 0) {
            quotePools[memberName] = [...(memberQuotesData[memberName] || ['Âä†Ê≤πÔºÅ', '‚ù§Ô∏è'])];
            for (let i = quotePools[memberName].length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quotePools[memberName][i], quotePools[memberName][j]] = [quotePools[memberName][j], quotePools[memberName][i]];
            }
        }
        return quotePools[memberName].pop();
    }

    function nextPage() { document.getElementById('page1').style.display='none'; document.getElementById('page2').style.display='flex'; pContainer.style.display='flex'; updateUI(); }
    function changeMember(dir) { curIdx = (curIdx + dir + members.length) % members.length; updateUI(); }
    
    function updateUI() { 
        const m = members[curIdx]; 
        // ÂàáÊç¢Êó∂ÂÖàÈÄèÊòéÔºåÂä†ËΩΩÂÆåÊàêÂêéÁû¨Èó¥ÊòæÁ§∫ÔºåÁî±‰∫éÈ¢ÑÂä†ËΩΩËøáÔºåËøôÈáå‰ºöÈùûÂ∏∏Âø´
        portrait.style.opacity = "0";
        setTimeout(() => {
            portrait.src = m.img; 
            portrait.style.transform = `scale(${m.scale}) translate(${m.x}px, ${-m.y}px)`; 
            portrait.style.opacity = "1"; 
            document.getElementById('char-name').innerText = m.name; 
            document.getElementById('char-text').innerText = m.text; 
        }, 80);
    }

    function setBrush(mode) {
        brushMode = mode;
        document.getElementById('mode-silky').className = mode === 'silky' ? 'active' : '';
        document.getElementById('mode-creamy').className = mode === 'creamy' ? 'active' : '';
    }

    function spawnMoodFeedback() {
        const m = members[curIdx];
        const randomQuote = getNextQuote(m.name);
        const wrap = document.createElement('div');
        wrap.className = 'mood-feedback-wrap';
        const rect = paintArea.getBoundingClientRect();
        const isLeft = Math.random() > 0.5;
        let randomX;
        if (isLeft) {
            randomX = rect.left - 60 + (Math.random() * 30); 
        } else {
            randomX = rect.right + 10 + (Math.random() * 30);
        }
        const randomY = rect.top + (Math.random() * (rect.height - 120)) + 60;
        wrap.style.left = randomX + "px";
        wrap.style.top = randomY + "px";
        wrap.innerHTML = `<div class="mood-bubble">${randomQuote}</div><img src="${m.circle}" class="mood-circle" onerror="this.src='${m.img}';">`;
        moodContainer.appendChild(wrap); 
        setTimeout(() => wrap.remove(), 1800);
    }

    function deselectAll() { document.querySelectorAll('.sticker-wrapper').forEach(w => w.classList.remove('active')); }

    function addSticker(content, isImage = false) {
        const wrap = document.createElement('div'); wrap.className = 'sticker-wrapper active'; deselectAll();
        wrap.innerHTML = `<span class="sticker-content">${isImage ? `<img src="${content}">` : content}</span><div class="handle handle-del">√ó</div><div class="handle handle-se"></div>`;
        let state = { x: 230, y: 180, s: 1, r: 0 };
        const update = () => { wrap.style.transform = `translate(${state.x}px, ${state.y}px) rotate(${state.r}deg) scale(${state.s})`; };
        wrap.onmousedown = (e) => {
            if (e.target.classList.contains('handle')) return;
            deselectAll(); wrap.classList.add('active');
            let sX = e.clientX - state.x, sY = e.clientY - state.y;
            const move = (me) => { state.x = me.clientX - sX; state.y = me.clientY - sY; update(); };
            const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
            window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
            e.stopPropagation();
        };
        wrap.querySelector('.handle-se').onmousedown = (e) => {
            e.stopPropagation(); const rect = wrap.getBoundingClientRect();
            const cX = rect.left + rect.width / 2, cY = rect.top + rect.height / 2;
            const sLen = Math.hypot(e.clientX - cX, e.clientY - cY), sAng = Math.atan2(e.clientY - cY, e.clientX - cX);
            const iS = state.s, iR = state.r;
            const move = (me) => {
                const cL = Math.hypot(me.clientX - cX, me.clientY - cY);
                state.s = iS * (cL / sLen); state.r = iR + (Math.atan2(me.clientY - cY, me.clientX - cX) - sAng) * (180 / Math.PI); update();
            };
            const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
            window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
        };
        wrap.querySelector('.handle-del').onclick = () => wrap.remove();
        paintArea.appendChild(wrap); update();
    }

    function initStickerVault() {
        const grid = document.getElementById('sticker-vault-grid');
        if (grid.children.length > 0) return;
        members.forEach(m => {
            const img = document.createElement('img'); img.src = m.circle; img.className = 'mini-sticker-btn';
            img.onclick = () => addSticker(m.circle, true); grid.appendChild(img);
        });
    }

    function startCrafting() { 
        pContainer.style.display='none'; document.getElementById('page2').style.display='none'; 
        document.getElementById('choco-craft-layer').style.display='flex'; 
        canvas.width = 540; canvas.height = 480; initCanvas(); initStickerVault();
    }
    
    function finishCrafting() {
        deselectAll();
        document.getElementById('choco-craft-layer').style.display = 'none';
        document.getElementById('unboxing-layer').style.display = 'flex';
        
        const layer = document.getElementById('unboxing-layer');
        document.querySelectorAll('.sparkle-deco').forEach(s => s.remove());
        for(let i=0; i<15; i++) {
            const s = document.createElement('div');
            s.className = 'sparkle-deco';
            s.innerText = ['‚ú¶', '‚úß', '‚ô•', '‚ú®'][Math.floor(Math.random()*4)];
            s.style.left = Math.random()*90 + 5 + 'vw';
            s.style.top = Math.random()*90 + 5 + 'vh';
            s.style.animationDelay = Math.random()*2 + 's';
            layer.appendChild(s);
        }

        const finalView = document.getElementById('final-choco-view');
        finalView.innerHTML = ""; 
        const chocoCopy = paintArea.cloneNode(true);
        chocoCopy.id = "choco-final-content";
        chocoCopy.style.cssText = "position:absolute; inset:0; border:none; background:transparent; z-index:10;";
        const doodleImg = new Image();
        doodleImg.src = canvas.toDataURL("image/png");
        doodleImg.style.cssText = "position:absolute; inset:0; z-index:10; width:100%; height:100%; pointer-events:none;";
        chocoCopy.querySelector('canvas').replaceWith(doodleImg);
        chocoCopy.querySelectorAll('.sticker-wrapper').forEach(s => {
            s.style.border = "none";
            s.style.zIndex = "20"; 
            s.querySelectorAll('.handle').forEach(h => h.remove());
        });
        chocoCopy.querySelectorAll('.mood-feedback-wrap').forEach(w => w.remove());
        finalView.appendChild(chocoCopy);
    }

    function showCallScreen() {
        const m = members[curIdx];
        document.getElementById('call-layer').style.display = 'block';
        const cardImg = m.name.toLowerCase() + "3.jpg";
        document.getElementById('call-bg-img').style.backgroundImage = `url(${cardImg})`;
        document.getElementById('caller-name').innerText = m.name;
        globalAudio.pause(); globalAudio.src = m.audio; globalAudio.load();
    }

    function acceptCall() {
        globalAudio.play();
        document.getElementById('play-icon').innerText = "‚ô´";
        const itv = setInterval(() => { if(!globalAudio.paused) spawnHeart(); else clearInterval(itv); }, 400);
    }

    function spawnHeart() {
        const h = document.createElement('div'); h.className = 'heart-particle'; h.innerText = '‚ô•';
        h.style.left = (Math.random() * 80 + 10) + 'vw'; h.style.bottom = '20vh';
        h.style.fontSize = (Math.random() * 20 + 15) + 'px';
        document.getElementById('heart-spawner').appendChild(h); setTimeout(() => h.remove(), 2000);
    }

    canvas.onmousedown = (e) => { writing = true; [lx, ly] = [e.offsetX, e.offsetY]; };
    canvas.onmousemove = (e) => { 
        if (!writing) return; 
        const size = parseInt(document.getElementById('pen-size').value);
        ctx.lineCap = "round"; ctx.lineJoin = "round";
        ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over'; 
        if (!isEraser && brushMode === 'creamy') {
            ctx.beginPath(); ctx.lineWidth = size; ctx.strokeStyle = penColor;
            ctx.shadowBlur = 3; ctx.shadowColor = 'rgba(0,0,0,0.25)'; ctx.moveTo(lx, ly); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
            ctx.beginPath(); ctx.lineWidth = size * 0.35; ctx.strokeStyle = 'rgba(255,255,255,0.35)';
            ctx.shadowBlur = 0; ctx.moveTo(lx, ly); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
        } else {
            ctx.beginPath(); ctx.lineWidth = size; ctx.strokeStyle = penColor; ctx.moveTo(lx, ly); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
        }
        [lx, ly] = [e.offsetX, e.offsetY]; 
        if (!window.lastMoodTime) window.lastMoodTime = 0;
        const now = Date.now();
        if (Math.random() < 0.006 && now - window.lastMoodTime > 1600) {
            spawnMoodFeedback();
            window.lastMoodTime = now;
        }
    };
    window.addEventListener('mouseup', () => writing = false);

    const macPal = ["#B2F2BB", "#FFD3E0", "#E5DBFF", "#FFF3BF", "#B3E5FC", "#FAD0C4", "#A1C4FD", "#FF9A9E"];
    const mG = document.getElementById('macaron-colors');
    macPal.forEach(c => {
        const d = document.createElement('div'); d.className = 'dot'; d.style.background = c;
        d.onclick = () => { isEraser=false; penColor=c; clearActive(); d.classList.add('active'); }; mG.appendChild(d);
    });
    const memG = document.getElementById('member-colors');
    members.forEach(m => {
        const d = document.createElement('div'); d.className = 'dot'; d.style.background = m.color;
        if(m.name === "TAKASHI") d.style.border = "2px solid #ccc"; 
        d.onclick = () => { isEraser=false; penColor=m.color; clearActive(); d.classList.add('active'); }; memG.appendChild(d);
    });

    function clearActive() { document.querySelectorAll('.dot').forEach(d => d.classList.remove('active')); }
    function toggleEraser() { isEraser = !isEraser; clearActive(); }
    function initCanvas() { ctx.clearRect(0,0,540,480); document.querySelectorAll('.sticker-wrapper').forEach(s => s.remove()); }
    globalAudio.onended = () => location.reload();
</script>
</body>
</html>